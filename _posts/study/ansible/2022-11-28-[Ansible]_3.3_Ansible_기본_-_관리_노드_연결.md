---
layout: post
title: "[Ansible] #3.3 Ansible 기본 - 관리 노드 연결"
subtitle: AWS
date: '2022-11-28 3:00:00 +0900'
category: study
tags: ansible
image:
  path: /assets/img/study_Ansible/2022-11-28-[Ansible]_3.3_Ansible_기본_-_관리_노드_연결/logo.png
---

`Ansible` 의 기본 구성요소인 `인벤토리` 에 대해서 알아보자.
<!--more-->

* this unordered seed list will be replaced by the toc
{:toc}

<br>

# 1. 관리 노드 연결 개념
---

기본적으로 노드간의 연결은 `SSH` 를 사용한다.

![1](/assets/img/study_Ansible/2022-11-28-[Ansible]_3.3_Ansible_기본_-_관리_노드_연결/1.png)

현재 `iac-control1` 의 유저는 기본 유저인 `vagrant` 이다.<br>
따라서 그대로 `vagrant` 유저로 `SSH` 연결을 시도한 것이다.<br>
참고로 비밀번호를 물어본다면, 기본 PW인 `vagrant` 를 입력하면 된다.

다른 사용자로 연결하려면, `@` 를 사용할 수 있다.

```shell
ssh ubuntu@192.168.56.21
```

`ubuntu` 사용자로 접속이 될까?<br>
대답은 'No' 다.<br>
그 이유는, `iac-node1` 에는 `ubuntu` 라는 사용자가 없기 때문이다.

또한 위에서 봐서 알겠지만, 기본적인 `SSH` 인증 방법은 `KEY 인증` 이 아닌, `PASSWORD 인증` 이다.<br>

사족으로 `PuTTY` 를 사용해서 `Amazon Linux EC2` 에 접속할때 `ppk` 를 사용해서 접속해본 경험이 있을텐데, 이런게 `KEY 인증` 이다.<br>
`EC2` 에 접속한 뒤 설정을 풀어주면 `PASSWORD 인증` 방식으로 변경도 가능하겠지만, `AWS` 에서는 기본적으로 `KEY 인증` 을 사용한다.<br>

```shell
sudo id
```

기본적으로 `sudo` 를 할 때 `PW` 를 묻지 않는다.<br>
이를 `Passwordless sudo` 라고 한다.<br>
이 설정은 `/etc/sudoers.d/vagrant` 에 있다.<br>
`vagrant` 사용자이기 때문에 `vagrant` 파일이 있는 것이다.<br>

파일 내부를 보자.<br>
`NOPASSWD:ALL` 설정이 되어 있으면, `sudo` 시 패스워드를 묻지 않는다.<br>
만약에 `ALL` 만 남기고 해당 옵션을 지우면, 그때부터 `sudo` 를 사용할 때 `PW` 를 물어본다.<br>
진짜 매번 물어보는건 아니고, 인증이 몇 분 정도는 유지되고 `exit` 하고 다시 접속하면 `PW` 를 묻는다.<br>
물론 `Default PW` 는 'vagrant' 다.<br>

# 2. 연결 방법 지정
---

`Ansible 제어 노드` 는 `관리 노드` 에 접근하기 위해 기본적으로 `OpenSSH` 를 사용한다.

- `ssh(기본)`, `WinRM`, `PSRP(Power Shell Remote Protocol)`, `Local(자기 자신)`
- `Docker`, `Docker-API` , `Kubectl`, `OC`
- `network_cli`
- `AWS Systems Manager(SSM)` (이 걸 이용해서 ec2 인스턴스에 접근도 가능)

```shell
ansible-doc -t connection -l
```

위 명령어를 입력하면 다양한 연결 방식들을 볼 수 있다.<br>

```shell
proxyserver ansible_connection=local
```
`인벤토리` 에서 `ansible_connection` 를 다른 연결 방식으로 지정할 수 있다. <br>
우리는 `ssh` 를 사용할 것인데다 기본이 `ssh` 이기 때문에, 별도로 지정하지 않아도 된다.

연결에 대한 `Ansible` 관련 명령 :
```shell
-c CONNECTION
--connection CONNECTION
```
이렇게도 옵션을 사용해서 지정할 수도 있다.

또한 `플레이북` 에서는 다음과 같이 지정할 수 있다.
```
- hosts : webservers
  connection : local
```

# 3. 관리 노드 연결 - SSH 인증 방식
---

`SSH` 인증 방식은 두 개로 나뉜다.
* `SSH` 키 인증 (기본값)
* `SSH` 패스워드 인증 : `-k` 또는 `--ask-pass` 옵션 사용

자 한 번 명령어로 접근해볼까 ?<br>

```shell
ansible mgmt -m command -a 'hostname'
```

접근 시 키가 없기 떄문에 인증이 불가능하여 접근이 거부된다.<br>
하지만 ?

```shell
ansible mgmt -m command -a 'hostname' --ask-pass
```

이렇게 `--ask-pass` 옵션을 사용하면 비밀번호를 입력받는다 !<br>
이제 비밀번호를 입력하면 접속할 수 있다.

물론 이렇게 접근할 수도 있지만, 접근해야할 노드가 엄청나게 많아질 경우 일일이 패스워드를 입력하는건 사실상 불가능하다.<br>
`DevOps` 로서 가장 중요한 덕목중 하나가 `자동화` 인 만큼, 이러한 대화형 형식을 사용하는 것은 바람직하지 않다.<br>
그래서 기본값이 키 인증인 것이다.<br>
패스워드 인증은 불가능하진 않겠지만 자동화하기 힘들고, 보안상 좋지 않다.<br>
절대 사용하지 않도록 하자.

```shell
cat ~/.ansible.cfg
```

`ask_pass` 를 `false` 로 해놓았기 때문에 비밀번호를 물어보지 않는다.

```shell
ssh-keygen
```

키를 생성할 때 편의상 모두 비워두고 키를 생성하였다.<br>
`id_rsa` 는 프라이빗 키, `id_rsa.pub` 은 공개 키이다.

```shell
ssh-copy-id vagrant@192.168.56.21
```

이제 키를 복사한 후 `ssh` 로 접속하면, 비밀번호를 물어보지 않고 접속된다.

```shell
ansible mgmt -m command -a 'hostname'
```
자 이제 접속이 안되었던 명령어도 제대로 작동이 된다.

지금의 제어 노드와 관리 노드는 모두 `vagrant` 사용자를 사용하고 있다.<br>
따라서 사용자를 따로 지정하지 않아도 `vagrant` 로 접속한다.<br>
그런데 만약 다른 사용자로 접속해야 할 경우, 그것을 지정해줘야 한다.

방법은 여러가지가 있다.<br>
뒤에 `-u` 옵션으로 유저명을 붙이는 방법이 있다.<br>
또한 `.ansible.cfg` 파일에서 `remote_user` 의 값을 바꿀 수 있다.

